networks:
  haus-netzwerk:
    external: true

services:
  cloudflared:
    image: cloudflare/cloudflared:latest
    container_name: sin-cloudflared-tunnel
    restart: unless-stopped
    command: tunnel --config /etc/cloudflared/config.yml run
    volumes:
      - ~/.cloudflared:/etc/cloudflared:ro
    networks:
      - haus-netzwerk
    depends_on:
      - n8n
      - dashboard
      - api-brain

  n8n:
    image: n8nio/n8n:latest
    container_name: sin-zimmer-01-n8n
    restart: unless-stopped
    environment:
      - N8N_HOST=n8n.delqhi.com
      - N8N_PROTOCOL=https
      - WEBHOOK_URL=https://n8n.delqhi.com/
      - N8N_ENCRYPTION_KEY=${N8N_ENCRYPTION_KEY:-sin-solver-2026}
    volumes:
      - n8n_data:/home/node/.n8n
    networks:
      - haus-netzwerk
    ports:
      - "5678:5678"
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:5678/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3

  chronos:
    build:
      context: ./services/chronos
      dockerfile: Dockerfile
    image: sin-chronos:latest
    container_name: sin-zimmer-02-chronos
    restart: unless-stopped
    environment:
      - NODE_ENV=production
      - PORT=3001
      - DATABASE_URL=postgresql://sin_admin:${POSTGRES_PASSWORD:-sin-solver-2026}@postgres:5432/sin_solver
      - API_BRAIN_URL=http://api-brain:8000
    networks:
      - haus-netzwerk
    ports:
      - "3001:3001"
    depends_on:
      postgres:
        condition: service_healthy
      api-brain:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:3001/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  agent-zero:
    image: frdel/agent-zero:latest
    container_name: sin-zimmer-03-agent-zero
    restart: unless-stopped
    environment:
      - API_KEY=${OPENAI_API_KEY:-}
    volumes:
      - agent_zero_data:/app/data
    networks:
      - haus-netzwerk
    ports:
      - "8050:8000"

  opencode:
    build:
      context: ./services/opencode
      dockerfile: Dockerfile
    image: sin-opencode:latest
    container_name: sin-zimmer-04-opencode
    restart: unless-stopped
    environment:
      - NODE_ENV=production
      - PORT=9000
      - DATABASE_URL=postgresql://sin_admin:${POSTGRES_PASSWORD:-sin-solver-2026}@postgres:5432/sin_solver
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - OPENCODE_API_KEY=${OPENCODE_API_KEY:-}
      - DEFAULT_PROVIDER=openai
    networks:
      - haus-netzwerk
    ports:
      - "9000:9000"
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:9000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  steel:
    image: browserless/chrome:latest
    container_name: sin-zimmer-05-steel
    restart: unless-stopped
    environment:
      - CONNECTION_TIMEOUT=60000
      - MAX_CONCURRENT_SESSIONS=5
    shm_size: '2gb'
    networks:
      - haus-netzwerk
    ports:
      - "3005:3000"
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:3000"]
      interval: 30s
      timeout: 10s
      retries: 3

  skyvern:
    image: browserless/chrome:latest
    container_name: sin-zimmer-06-skyvern
    restart: unless-stopped
    environment:
      - CONNECTION_TIMEOUT=60000
      - MAX_CONCURRENT_SESSIONS=10
    shm_size: '2gb'
    networks:
      - haus-netzwerk
    ports:
      - "8030:3000"
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:3000"]
      interval: 30s
      timeout: 10s
      retries: 3

  stagehand:
    image: browserless/chrome:latest
    container_name: sin-zimmer-07-stagehand
    restart: unless-stopped
    environment:
      - CONNECTION_TIMEOUT=60000
      - MAX_CONCURRENT_SESSIONS=10
    shm_size: '2gb'
    networks:
      - haus-netzwerk
    ports:
      - "3007:3000"
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:3000"]
      interval: 30s
      timeout: 10s
      retries: 3

  qa-tester:
    build:
      context: ./services/qa
      dockerfile: Dockerfile
    image: sin-qa:latest
    container_name: sin-zimmer-08-qa
    restart: unless-stopped
    environment:
      - NODE_ENV=production
      - PORT=8080
      - DATABASE_URL=postgresql://sin_admin:${POSTGRES_PASSWORD:-sin-solver-2026}@postgres:5432/sin_solver
      - API_BRAIN_URL=http://api-brain:8000
      - DASHBOARD_URL=http://dashboard:80
    networks:
      - haus-netzwerk
    ports:
      - "8008:8080"
    depends_on:
      - api-brain
      - dashboard
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  clawdbot:
    build:
      context: ./services/clawdbot
      dockerfile: Dockerfile
    image: sin-clawdbot:latest
    container_name: sin-zimmer-09-clawdbot
    restart: unless-stopped
    environment:
      - NODE_ENV=production
      - PORT=8080
      - DATABASE_URL=postgresql://sin_admin:${POSTGRES_PASSWORD:-sin-solver-2026}@postgres:5432/sin_solver
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN:-}
      - TELEGRAM_CHAT_ID=${TELEGRAM_CHAT_ID:-}
      - DISCORD_WEBHOOK_URL=${DISCORD_WEBHOOK_URL:-}
      - API_BRAIN_URL=http://api-brain:8000
    networks:
      - haus-netzwerk
    ports:
      - "8009:8080"
    depends_on:
      postgres:
        condition: service_healthy
      api-brain:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  postgres:
    image: postgres:16-alpine
    container_name: sin-zimmer-10-postgres
    restart: unless-stopped
    environment:
      - POSTGRES_USER=sin_admin
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-sin-solver-2026}
      - POSTGRES_DB=sin_solver
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./postgres/init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    networks:
      - haus-netzwerk
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U sin_admin -d sin_solver"]
      interval: 10s
      timeout: 5s
      retries: 5

  dashboard:
    build:
      context: ./services/dashboard
      dockerfile: Dockerfile
    image: sin-dashboard:latest
    container_name: sin-zimmer-11-dashboard
    restart: unless-stopped
    networks:
      - haus-netzwerk
    ports:
      - "3011:80"
    depends_on:
      - api-brain
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:80"]
      interval: 30s
      timeout: 10s
      retries: 3

  evolution:
    build:
      context: ./services/evolution
      dockerfile: Dockerfile
    image: sin-evolution:latest
    container_name: sin-zimmer-12-evolution
    restart: unless-stopped
    environment:
      - NODE_ENV=production
      - PORT=8080
      - DATABASE_URL=postgresql://sin_admin:${POSTGRES_PASSWORD:-sin-solver-2026}@postgres:5432/sin_solver
      - API_BRAIN_URL=http://api-brain:8000
    networks:
      - haus-netzwerk
    ports:
      - "8012:8080"
    depends_on:
      postgres:
        condition: service_healthy
      api-brain:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  api-brain:
    build:
      context: ./services/api-brain
      dockerfile: Dockerfile
    image: sin-api-brain:latest
    container_name: sin-zimmer-13-api-brain
    restart: unless-stopped
    environment:
      - NODE_ENV=production
      - PORT=8000
      - DATABASE_URL=postgresql://sin_admin:${POSTGRES_PASSWORD:-sin-solver-2026}@postgres:5432/sin_solver
    networks:
      - haus-netzwerk
    ports:
      - "8031:8000"
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  worker:
    build:
      context: ./services/worker
      dockerfile: Dockerfile
    image: sin-worker:latest
    container_name: sin-zimmer-14-worker
    restart: unless-stopped
    environment:
      - NODE_ENV=production
      - WORKER_NAME=worker-1
      - WORKER_TYPE=general
      - API_BRAIN_URL=http://api-brain:8000
      - STAGEHAND_URL=http://stagehand:3000
      - HEARTBEAT_INTERVAL=30000
    networks:
      - haus-netzwerk
    ports:
      - "8014:8080"
    depends_on:
      api-brain:
        condition: service_healthy
      stagehand:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  surfsense:
    image: qdrant/qdrant:latest
    container_name: sin-zimmer-15-surfsense
    restart: unless-stopped
    volumes:
      - qdrant_data:/qdrant/storage
    networks:
      - haus-netzwerk
    ports:
      - "6333:6333"
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:6333/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  supabase-db:
    image: postgres:16-alpine
    container_name: sin-zimmer-16-supabase
    restart: unless-stopped
    environment:
      - POSTGRES_USER=supabase_admin
      - POSTGRES_PASSWORD=${SUPABASE_PASSWORD:-supabase-2026}
      - POSTGRES_DB=supabase
    volumes:
      - supabase_data:/var/lib/postgresql/data
    networks:
      - haus-netzwerk
    ports:
      - "5433:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U supabase_admin -d supabase"]
      interval: 10s
      timeout: 5s
      retries: 5

  sin-plugins-mcp:
    build:
      context: ./services/mcp
      dockerfile: Dockerfile
    image: sin-mcp:latest
    container_name: sin-zimmer-17-mcp
    restart: unless-stopped
    environment:
      - NODE_ENV=production
      - PORT=8000
      - API_BRAIN_URL=http://api-brain:8000
    networks:
      - haus-netzwerk
    ports:
      - "8040:8000"
    depends_on:
      - api-brain
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  serena-mcp:
    image: sin-serena-mcp:latest
    container_name: sin-serena-mcp-prod
    restart: unless-stopped
    networks:
      - haus-netzwerk
    ports:
      - "3000:3000"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

volumes:
  n8n_data:
  agent_zero_data:
  skyvern_data:
  postgres_data:
  qdrant_data:
  supabase_data:
