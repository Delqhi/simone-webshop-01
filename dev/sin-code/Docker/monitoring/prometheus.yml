# =============================================================================
# PROMETHEUS CONFIGURATION - SIN-SOLVER MONITORING
# =============================================================================

global:
  scrape_interval: 15s
  evaluation_interval: 15s
  external_labels:
    monitor: 'sin-solver-prometheus'
    environment: 'production'
    region: 'eu-berlin'

# Alerting configuration
alerting:
  alertmanagers:
    - static_configs:
        - targets:
            - room-00-alertmanager:9093

# Load rules once and periodically evaluate them
rule_files:
  - "alert-rules.yml"

# Scrape configurations
scrape_configs:
  # ===========================================================================
  # MONITORING INFRASTRUCTURE
  # ===========================================================================
  
  - job_name: 'prometheus'
    static_configs:
      - targets: ['localhost:9090']
        labels:
          instance: 'prometheus-primary'

  - job_name: 'alertmanager'
    static_configs:
      - targets: ['room-00-alertmanager:9093']
        labels:
          instance: 'alertmanager-primary'

  - job_name: 'node-exporter'
    static_configs:
      - targets: ['room-00-node-exporter:9100']
        labels:
          instance: 'macos-host'
          job_type: 'infrastructure'

  - job_name: 'cadvisor'
    static_configs:
      - targets: ['room-00-cadvisor:8080']
        labels:
          instance: 'docker-metrics'
          job_type: 'infrastructure'

  - job_name: 'loki'
    static_configs:
      - targets: ['room-00-loki:3100']
        labels:
          instance: 'loki-primary'

  # ===========================================================================
  # AGENT SERVICES
  # ===========================================================================
  
  - job_name: 'agent-01-n8n'
    metrics_path: '/metrics'
    scrape_interval: 30s
    static_configs:
      - targets: ['agent-01-n8n-manager:5678']
        labels:
          instance: 'n8n'
          service_type: 'orchestration'

  - job_name: 'agent-02-temporal'
    metrics_path: '/metrics'
    scrape_interval: 30s
    static_configs:
      - targets: ['agent-02-temporal-scheduler:3001']
        labels:
          instance: 'temporal-scheduler'
          service_type: 'scheduling'

  - job_name: 'agent-04-opencode'
    metrics_path: '/metrics'
    scrape_interval: 30s
    static_configs:
      - targets: ['agent-04-opencode-coder:9000']
        labels:
          instance: 'opencode-coder'
          service_type: 'ai-provider'

  - job_name: 'agent-05-steel'
    metrics_path: '/metrics'
    scrape_interval: 30s
    static_configs:
      - targets: ['agent-05-steel-browser:3000']
        labels:
          instance: 'steel-browser'
          service_type: 'automation'

  - job_name: 'agent-06-skyvern'
    metrics_path: '/metrics'
    scrape_interval: 30s
    static_configs:
      - targets: ['agent-06-skyvern-solver:8000']
        labels:
          instance: 'skyvern'
          service_type: 'vision-ai'

  # ===========================================================================
  # ROOM SERVICES (INFRASTRUCTURE)
  # ===========================================================================
  
  - job_name: 'room-01-portainer'
    static_configs:
      - targets: ['room-01-dashboard-cockpit:9000']
        labels:
          instance: 'portainer'
          service_type: 'dashboard'

  - job_name: 'room-03-postgres'
    static_configs:
      - targets: ['room-03-archiv-postgres:5432']
        labels:
          instance: 'postgres-primary'
          service_type: 'database'

  - job_name: 'room-04-redis'
    static_configs:
      - targets: ['room-04-memory-redis:6379']
        labels:
          instance: 'redis-cache'
          service_type: 'cache'

  # ===========================================================================
  # SERVICE DISCOVERY - Auto-discover labeled services
  # ===========================================================================
  
  - job_name: 'docker-containers'
    static_configs:
      - targets: ['room-00-cadvisor:8080']
    relabel_configs:
      # Only scrape containers with prometheus=true label
      - source_labels: [__meta_docker_container_label_prometheus]
        regex: 'true'
        action: 'keep'

  # ===========================================================================
  # BLACKBOX MONITORING - External HTTP checks
  # ===========================================================================
  
  - job_name: 'blackbox-http'
    metrics_path: /probe
    params:
      module: [http_2xx]
    scrape_interval: 60s
    static_configs:
      - targets:
          - 'https://delqhi.com'
          - 'https://n8n.delqhi.com'
          - 'https://grafana.delqhi.com'
          - 'https://portainer.delqhi.com'
        labels:
          job_type: 'external-monitoring'

