# =============================================================================
# PROMTAIL CONFIGURATION - Log shipper for Docker containers
# =============================================================================

server:
  http_listen_port: 3101
  grpc_listen_port: 0

positions:
  filename: /tmp/positions.yaml

clients:
  - url: http://room-00-loki:3100/loki/api/v1/push

scrape_configs:
  # ===========================================================================
  # DOCKER CONTAINER LOGS
  # ===========================================================================
  
  - job_name: docker
    docker_sd_configs:
      - host: unix:///var/run/docker.sock
        refresh_interval: 10s
        filters:
          - name: status
            values: [running]

    relabel_configs:
      # Docker container name as instance label
      - source_labels: ['__meta_docker_container_name']
        target_label: 'instance'

      # Docker container hostname
      - source_labels: ['__meta_docker_container_hostname']
        target_label: 'hostname'

      # Docker image name
      - source_labels: ['__meta_docker_container_image_name']
        target_label: 'image'

      # Service type from labels
      - source_labels: ['__meta_docker_container_label_service_type']
        target_label: 'service_type'

      # Extract job from container name (e.g., agent-01-n8n -> agent)
      - source_labels: ['__meta_docker_container_name']
        regex: '(agent|room|solver|builder)-.*'
        target_label: 'job'

      # Parse container labels as tags
      - source_labels: ['__meta_docker_container_label_monitoring']
        target_label: 'monitoring'

    pipeline_stages:
      # Parse JSON logs
      - json:
          expressions:
            timestamp: timestamp
            level: level
            message: message
            error: error
            stack: stack

      # Extract timestamp
      - timestamp:
          source: timestamp
          format: RFC3339Nano

      # Extract log level
      - labels:
          level:
          service_type:
          image:

      # Multi-line parsing for stack traces
      - multiline:
          line_separator: '\n'
          max_lines: 10
          regex: '^(\d{4}-\d{2}-\d{2}|Traceback|Error|at )'

  # ===========================================================================
  # HOST SYSTEM LOGS (if available)
  # ===========================================================================
  
  - job_name: syslog
    static_configs:
      - targets:
          - localhost
        labels:
          job: syslog
          instance: macos-host
    syslog_sd_configs:
      - listen_address: "0.0.0.0:514"

    relabel_configs:
      - source_labels: ['__syslog_message_hostname']
        target_label: 'hostname'
      - source_labels: ['__syslog_message_severity']
        target_label: 'severity'
      - source_labels: ['__syslog_message_facility']
        target_label: 'facility'

